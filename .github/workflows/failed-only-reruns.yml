# .github/workflows/playwright-rerun-failed.yml
# ‚úÖ Purpose: Rerun ONLY the failed Playwright test cases using TestDino metadata.

name: Rerun Failed Playwright Tests

on:
  workflow_dispatch:   # manual trigger for reruns (can add workflow_run later)

jobs:
  rerun-failed-tests:
    name: Rerun Failed Playwright Tests
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/playwright:latest

    env:
      TESTDINO_TOKEN: ${{ secrets.TESTDINO_TOKEN }}
      TESTDINO_RUNTIME: staging
      USERNAME: ${{ secrets.USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}
      NEW_PASSWORD: ${{ secrets.NEW_PASSWORD }}
      FIRST_NAME: ${{ secrets.FIRST_NAME }}
      STREET_NAME: ${{ secrets.STREET_NAME }}
      CITY: ${{ secrets.CITY }}
      STATE: ${{ secrets.STATE }}
      COUNTRY: ${{ secrets.COUNTRY }}
      ZIP_CODE: ${{ secrets.ZIP_CODE }}

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      # 2Ô∏è‚É£ Set safe directory for git inside container
      - name: Set safe directory
        run: |
          echo "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # 3Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      # 4Ô∏è‚É£ Install dependencies + browsers
      - name: Install dependencies and Playwright
        run: |
          npm ci
          npx playwright install --with-deps chromium

      # 5Ô∏è‚É£ Create .env file with secrets (same as daily workflow)
      - name: Create .env file
        run: |
          echo "USERNAME=${{ secrets.USERNAME }}" >> .env
          echo "PASSWORD=${{ secrets.PASSWORD }}" >> .env
          echo "NEW_PASSWORD=${{ secrets.NEW_PASSWORD }}" >> .env
          echo "FIRST_NAME=${{ secrets.FIRST_NAME }}" >> .env
          echo "STREET_NAME=${{ secrets.STREET_NAME }}" >> .env
          echo "CITY=${{ secrets.CITY }}" >> .env
          echo "STATE=${{ secrets.STATE }}" >> .env
          echo "COUNTRY=${{ secrets.COUNTRY }}" >> .env
          echo "ZIP_CODE=${{ secrets.ZIP_CODE }}" >> .env

      # 6Ô∏è‚É£ Get last failed tests using TestDino CLI
      - name: Get last failed tests with tdpw
        id: last-failed
        run: |
          TESTDINO_RUNTIME="staging" npx tdpw last-failed > last-failed-flags.txt
          EXTRA_FLAGS="$(cat last-failed-flags.txt)"
          echo "extra-flags=$EXTRA_FLAGS" >> $GITHUB_OUTPUT

      # 7Ô∏è‚É£ Run only failed tests
      - name: Run Failed Tests Only
        run: |
          if [ -s last-failed-flags.txt ]; then
            echo "üîÅ Rerunning failed tests..."
            npx playwright test ${{ steps.last-failed.outputs.extra-flags }}
          else
            echo "‚úÖ No failed tests found. Skipping rerun."
          fi

      # 8Ô∏è‚É£ Cache tdpw metadata (so next rerun knows what failed)
      - name: Cache tdpw metadata
        if: always()
        run: npx tdpw cache

      # 9Ô∏è‚É£ Upload Playwright rerun report
      - name: Upload Playwright Rerun Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-rerun
          path: playwright-report/
          retention-days: 2

      # üîü Send rerun report to TestDino
      - name: Send Rerun Report to TestDino
        if: always()
        run: |
          TESTDINO_RUNTIME="staging" npx --yes tdpw ./playwright-report \
            --token="${{ secrets.TESTDINO_TOKEN }}" \
            --upload-html \
            --upload-traces \
            --verbose
